{% extends "base.html" %}
{% block title %}–í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ{% endblock %}

{% block content %}
<div class="row">
  <!-- Forma chap tarafda -->
  <div class="col-md-4">
    <h3 class="mb-4">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</h3>     
    <div class="card shadow p-4 mb-4">
      <h4 class="mb-3">–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ</h4>
      <form method="post">
        {% csrf_token %}
        <div class="mb-3">
          <label class="form-label">–†–æ—Å—Ç (—Å–º)</label>
          <input type="number" name="height" value="{{ userhealth.height|default:'' }}" class="form-control" required>
        </div>
        <div class="mb-3">
          <label class="form-label">–í–µ—Å (–∫–≥)</label>
          <input type="number" name="weight" value="{{ userhealth.weight|default:'' }}" class="form-control" required>
        </div>
        <div class="mb-3">
          <label class="form-label">–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è</label>
          <div class="input-group">
            <input type="datetime-local" name="datetime" class="form-control">
            <button type="button" class="btn btn-outline-secondary" onclick="setNow()">‚è∞ –°–µ–π—á–∞—Å</button>
          </div>
        </div>
        <div class="mb-3">
          <label class="form-label">–ì–ª—é–∫–æ–∑–∞ (–º–º–æ–ª—å/–ª)</label>
          <input type="number" step="0.1" name="glucose" class="form-control" required>
        </div>
        <button type="submit" class="btn btn-success w-100">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </form>
    </div>
    <a href="{% url 'export_pdf' %}" class="btn btn-outline-success w-100">üìÑ –°–∫–∞—á–∞—Ç—å PDF (28 –¥–Ω–µ–π)</a>
  </div>

  <!-- Grafiklar o‚Äòng tarafda -->
  <div class="col-md-8">
    <div class="card shadow p-4 mb-4">
      <h4 class="mb-3">–ì–ª—é–∫–æ–∑–∞ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ –¥–Ω–∏</h4>
      <canvas id="glucoseChart" height="100"></canvas>
    </div>

    <div class="row">
      <div class="col-md-6">
        <div class="card shadow p-3">
          <h5 class="text-center">–†–æ—Å—Ç</h5>
          <canvas id="heightChart" height="150"></canvas>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card shadow p-3">
          <h5 class="text-center">–í–µ—Å</h5>
          <canvas id="weightChart" height="150"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Grafik scriptlari -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  // "–°–µ–π—á–∞—Å" tugmasi
  function setNow() {
    let now = new Date();
    let formatted = now.toISOString().slice(0,16); // YYYY-MM-DDTHH:mm
    document.querySelector('input[name="datetime"]').value = formatted;
  }

  const dates = {{ dates|safe }};
  const glucose = {{ glucose_values|safe }};
  const height = {{ height_values|safe }};
  const weight = {{ weight_values|safe }};

  new Chart(document.getElementById('glucoseChart'), {
    type: 'line',
    data: {
      labels: dates,
      datasets: [{
        label: '–ì–ª—é–∫–æ–∑–∞',
        data: glucose,
        borderColor: '#2e7d32',
        backgroundColor: '#b2efb7',
        fill: true,
        tension: 0.3
      }]
    }
  });

  new Chart(document.getElementById('heightChart'), {
    type: 'line',
    data: {
      labels: dates,
      datasets: [{
        label: '–†–æ—Å—Ç',
        data: height,
        borderColor: '#0288d1',
        backgroundColor: '#b3e5fc',
        fill: true
      }]
    }
  });

  new Chart(document.getElementById('weightChart'), {
    type: 'line',
    data: {
      labels: dates,
      datasets: [{
        label: '–í–µ—Å',
        data: weight,
        borderColor: '#c62828',
        backgroundColor: '#ef9a9a',
        fill: true
      }]
    }
  });
</script>
{% endblock %}
